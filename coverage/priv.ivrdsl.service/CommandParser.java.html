<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>CommandParser.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">TestUtils Coverage Results, TestGenerator Coverage Results, TestException
    Coverage Results</a> &gt; <a href="index.source.html" class="el_package">priv.ivrdsl.service</a> &gt; <span
        class="el_source">CommandParser.java</span></div>
<h1>CommandParser.java</h1>
<pre class="source lang-java linenums">package priv.ivrdsl.service;

import com.beust.jcommander.JCommander;
import org.apache.commons.io.FileUtils;
import priv.ivrdsl.exception.ParametersException;
import priv.ivrdsl.exception.SyntaxErrorException;
import priv.ivrdsl.model.Commands;
import priv.ivrdsl.model.IvrMap;

import java.io.File;
import java.io.IOException;

import static priv.ivrdsl.model.EnumBean.Command;
import static priv.ivrdsl.controller.ApiSetter.setApi;
import static priv.ivrdsl.controller.JdbcSetter.setJdbc;
import static priv.ivrdsl.util.StringProcessUtils.removeLastChar;

/**
 * 分析单个用户命令。
 *
 * @author Guanidine Beryllium
 * @see Commands
 */
public class CommandParser {
    Commands.CommandConfig config;
    Commands.CommandInit init;
    Commands.CommandAdd add;
    Commands.CommandRemove remove;
    Commands.CommandStatus status;
    Commands.CommandExport export;
    Commands.CommandTest test;
    Commands.CommandHelp help;

<span class="nc" id="L34">    private CommandParser() {</span>
<span class="nc" id="L35">        config = new Commands.CommandConfig();</span>
<span class="nc" id="L36">        init = new Commands.CommandInit();</span>
<span class="nc" id="L37">        add = new Commands.CommandAdd();</span>
<span class="nc" id="L38">        remove = new Commands.CommandRemove();</span>
<span class="nc" id="L39">        status = new Commands.CommandStatus();</span>
<span class="nc" id="L40">        export = new Commands.CommandExport();</span>
<span class="nc" id="L41">        test = new Commands.CommandTest();</span>
<span class="nc" id="L42">        help = new Commands.CommandHelp();</span>
<span class="nc" id="L43">    }</span>

    /**
     * 解析单个命令，并将结果记录在 {@code schema} 中。
     *
     * @param args   单个命令
     * @param path   当前逻辑路径
     * @param schema trigger-event 映射
     * @return 处理完命令后的逻辑路径
     * @throws IOException 配置文件读取失败
     * @see priv.ivrdsl.service.IvrParser
     * @see IvrMap
     */
    public static String commandParser(String[] args, String path, IvrMap schema) throws IOException {
<span class="nc" id="L57">        CommandParser cm = new CommandParser();</span>
        JCommander jc =
<span class="nc" id="L59">                JCommander.newBuilder()</span>
<span class="nc" id="L60">                        .addObject(cm)</span>
<span class="nc" id="L61">                        .addCommand(&quot;init&quot;, cm.init)</span>
<span class="nc" id="L62">                        .addCommand(&quot;add&quot;, cm.add)</span>
<span class="nc" id="L63">                        .addCommand(&quot;remove&quot;, cm.remove)</span>
<span class="nc" id="L64">                        .addCommand(&quot;status&quot;, cm.status)</span>
<span class="nc" id="L65">                        .addCommand(&quot;export&quot;, cm.export)</span>
<span class="nc" id="L66">                        .addCommand(&quot;test&quot;, cm.test)</span>
<span class="nc" id="L67">                        .addCommand(&quot;config&quot;, cm.config)</span>
<span class="nc" id="L68">                        .addCommand(&quot;help&quot;, cm.help)</span>
<span class="nc" id="L69">                        .build();</span>
<span class="nc" id="L70">        jc.parse(args);</span>
<span class="nc" id="L71">        Command command = Command.getByCode(jc.getParsedCommand());</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (command == null) {</span>
<span class="nc" id="L73">            return null;</span>
        }
<span class="nc bnc" id="L75" title="All 9 branches missed.">        switch (command) {</span>
            case COMMAND_CONFIG -&gt; {
<span class="nc bnc" id="L77" title="All 2 branches missed.">                if (cm.config.help) {</span>
<span class="nc" id="L78">                    jc.usage();</span>
                }
<span class="nc bnc" id="L80" title="All 6 branches missed.">                if (cm.config.appId != null || cm.config.apiKey != null || cm.config.secretKey != null) {</span>
<span class="nc" id="L81">                    setApi(cm.config.appId, cm.config.apiKey, cm.config.secretKey, cm.config.apiConfig);</span>
                }
<span class="nc bnc" id="L83" title="All 10 branches missed.">                if (cm.config.table != null || cm.config.driver != null || cm.config.url != null || cm.config.user != null || cm.config.passwd != null) {</span>
<span class="nc" id="L84">                    String result = setJdbc(cm.config.table, cm.config.driver, cm.config.url, cm.config.user, cm.config.passwd, cm.config.jdbcConfig);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L86">                        throw new ParametersException(&quot;ERROR: In command \&quot;config\&quot;, parameters \&quot;table\&quot;, &quot; +</span>
                                &quot;\&quot;driver\&quot;, \&quot;url\&quot;, \&quot;user\&quot; and \&quot;passwd\&quot; &quot; + &quot;are expected to appear in group, &quot; +
                                &quot;missing &quot; + result);
                    }
<span class="nc" id="L90">                }</span>
            }
<span class="nc" id="L92">            case COMMAND_INIT -&gt; {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (cm.init.help) {</span>
<span class="nc" id="L94">                    jc.usage();</span>
                }
<span class="nc" id="L96">                schema.put(path, cm.init.title, &quot;&quot;, cm.init.playback);</span>
<span class="nc" id="L97">                path += &quot;$&quot;;</span>
            }
<span class="nc" id="L99">            case COMMAND_ADD -&gt; {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (cm.add.help) {</span>
<span class="nc" id="L101">                    jc.usage();</span>
                }
<span class="nc bnc" id="L103" title="All 4 branches missed.">                if (path.length() &lt; 3 &amp;&amp; &quot;back&quot;.equalsIgnoreCase(cm.add.action)) {</span>
<span class="nc" id="L104">                    throw new SyntaxErrorException(&quot;ERROR: Cannot execute \&quot;back\&quot; action in the main menu, &quot; +</span>
                            &quot;got (add -event=&quot; + cm.add.event + &quot; -action=back)&quot;);
                }
<span class="nc" id="L107">                path = removeLastChar(path) + cm.add.button;</span>
<span class="nc" id="L108">                schema.put(path, cm.add.event, cm.add.action, String.join(&quot; &quot;, cm.add.additions));</span>
            }
            case COMMAND_REMOVE -&gt; {
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (cm.remove.help) {</span>
<span class="nc" id="L112">                    jc.usage();</span>
                }
<span class="nc" id="L114">                schema.remove(cm.remove.path);</span>
<span class="nc bnc" id="L115"
      title="All 2 branches missed.">                if (path.startsWith(cm.remove.path)) {</span>
<span class="nc" id="L116">                    path = removeLastChar(cm.remove.path) + &quot;$&quot;;</span>
                }
            }
<span class="nc" id="L119">            case COMMAND_STATUS -&gt; {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (cm.status.help) {</span>
<span class="nc" id="L121">                    jc.usage();</span>
                }
<span class="nc" id="L123">                System.out.println(schema.toString());</span>
            }
<span class="nc" id="L125">            case COMMAND_EXPORT -&gt; {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (cm.export.help) {</span>
<span class="nc" id="L127">                    jc.usage();</span>
                }
<span class="nc bnc" id="L129" title="All 6 branches missed.">                String url = (cm.export.exportPath.length() == 0 || cm.export.exportPath.endsWith(&quot;/&quot;) || cm.export.exportPath.endsWith(&quot;\\&quot;)) ?</span>
<span class="nc" id="L130">                        cm.export.exportPath + &quot;VoiceMenu&quot; : cm.export.exportPath + &quot;/VoiceMenu&quot;;</span>
<span class="nc" id="L131">                File dir = new File(url);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (!dir.exists()) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                    if (!dir.mkdir()) {</span>
<span class="nc" id="L134">                        throw new IOException();</span>
                    }
                }
<span class="nc" id="L137">                FileUtils.copyFile(new File(&quot;target/ivrdsl-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;),</span>
                        new File(url + &quot;/ivrdsl-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;));
<span class="nc" id="L139">                Generator gen = new Generator(url, schema);</span>
<span class="nc" id="L140">                gen.generateIvr();</span>
            }
<span class="nc" id="L142">            case COMMAND_TEST -&gt; {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (cm.test.help) {</span>
<span class="nc" id="L144">                    jc.usage();</span>
                }
<span class="nc" id="L146">                String filepath = &quot;src/main/java/priv/ivrdsl/&quot;;</span>
<span class="nc" id="L147">                String packagePath = &quot;package priv.ivrdsl&quot;;</span>
<span class="nc" id="L148">                Generator gen = new Generator(filepath, schema, packagePath);</span>
<span class="nc" id="L149">                gen.generateIvr();</span>
            }
            case COMMAND_HELP -&gt; {
<span class="nc" id="L152">                jc.usage();</span>
            }
        }
<span class="nc" id="L155">        return path;</span>
    }
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>
</div>
</body>
</html>