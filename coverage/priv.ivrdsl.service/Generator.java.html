<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>Generator.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">Unit Test Coverage Results</a> &gt; <a href="index.source.html"
                                                                                      class="el_package">priv.ivrdsl.service</a>
    &gt; <span class="el_source">Generator.java</span></div>
<h1>Generator.java</h1>
<pre class="source lang-java linenums">package priv.ivrdsl.service;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.RandomStringUtils;
import priv.ivrdsl.model.EnumBean;
import priv.ivrdsl.model.IvrMap;

import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;
import java.util.*;

import static priv.ivrdsl.util.StringProcessUtils.getLastChar;
import static priv.ivrdsl.util.StringProcessUtils.removeLastChar;

/**
 * Java 生成器。将编译后的 IVR 脚本解析成 Java 程序。
 *
 * @author Guanidine Beryllium
 */
<span class="fc" id="L21">@Slf4j</span>
public class Generator {
    /** 代码块位置 */
    private int idx;
    /** 输出路径 */
    private final String filename;
    /** 程序代码字符串构造器 */
    private final StringBuilder ivrBuilder;
    /** 每一个生成的程序独有的 ID */
    private final String eventRandomName;
    /** 代码生成依据的逻辑 */
    private final IvrMap schema;

    /**
     * 构造一个 Java 生成器。指定包路径 {@code packagePath} 可以使得生成的程序在项目中运行。
     *
     * @param filepath    Java 文件保存路径（不包括文件名，因为生成的文件名是固定的）
     * @param schema      IVR trigger-event映射
     * @param packagePath 项目包路径
     * @see IvrMap
     */
<span class="fc" id="L42">    public Generator(String filepath, IvrMap schema, String packagePath) {</span>
<span class="fc" id="L43">        String STR = &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;;</span>
<span class="fc" id="L44">        this.eventRandomName = &quot;_&quot; + RandomStringUtils.random(6, STR);</span>
<span class="fc" id="L45">        this.filename = filepath + &quot;/VoiceMenu.java&quot;;</span>
<span class="fc" id="L46">        this.ivrBuilder = new StringBuilder();</span>
<span class="fc" id="L47">        this.schema = schema;</span>

<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        packagePath = &quot;&quot;.equals(packagePath) ? &quot;&quot; : packagePath + &quot;;\n\n&quot;;</span>
<span class="fc" id="L50">        String begin = &quot;&quot;&quot;</span>
                /*Generated by IVR DSL */
                                
                import org.dom4j.DocumentException;
                import priv.ivrdsl.model.EventBean;
                import priv.ivrdsl.model.GlobalVariableBean;
                import priv.ivrdsl.impl.QueryCaseImpl;
                import priv.ivrdsl.service.EventLogic;
                import priv.ivrdsl.util.VoiceOutputUtils;
                import priv.ivrdsl.view.Init;
                                
                import java.awt.event.ActionEvent;
                import java.awt.event.ActionListener;
                import java.io.IOException;

                /**
                 * IVR 主程序。调用 {@code main} 方法运行。
                 * &lt;p&gt;
                 * 由 IVR DSL Compiler 自动生成，运行 {@code Application} 以调用 Compiler 的接口。
                 *
                 * @author Guanidine Beryllium
                 * @see Application
                 */
                public class VoiceMenu implements ActionListener {

                    /** 初始化一个事件监听实例 */
                    public static VoiceMenu instance;

                    /**
                     * 构造 trigger-event 树。
                     *
                     * @see priv.ivrdsl.model.IvrMap
                     */
                    public static void initHashMap() {
                &quot;&quot;&quot;;
<span class="fc" id="L85">        String end = &quot;&quot;&quot;</span>
                    }
                    
                    public static void main(String[] args) {
                        initHashMap();
                        instance = new VoiceMenu();
                        VoiceMenu.initHashMap();
                        Init.initView(instance);
                        EventLogic.runInitSetup();
                    }
                    
                    @Override
                    public void actionPerformed(ActionEvent event) {
                        boolean isValidVariable = !(((GlobalVariableBean.curTriggerPath == null || GlobalVariableBean.curTriggerPath.length() == 0) || GlobalVariableBean.hasFinished || !GlobalVariableBean.hasStarted));
                        if (isValidVariable) {
                            try {
                                try {
                                    if (VoiceOutputUtils.waitingThr.isAlive()) {
                                        VoiceOutputUtils.waitingThr.interrupt();
                                    }
                                } catch (Exception e) {
                                    e.printStackTrace();
                                }
                                EventLogic.runLogic(event, queryCase);
                            } catch (IOException | InterruptedException | DocumentException e) {
                                e.printStackTrace();
                            }
                        }
                    }
                    
                    /**
                     * {@code QueryCaseImpl} 为返回 {@code String} 类型的接口。
                     * &lt;p&gt;
                     * 重载此接口，如调用第三方库的方法，以获取数据库查询语句的查询条件，如用户电话号码。
                     * &lt;p&gt;
                     * 返回字符串格式为 SQL {@code select} 语法中的 {@code where} 部分，例如 {@code return &quot;where mobile = 18987654321&quot;}。
                     *
                     * @see QueryCaseImpl
                     * @see priv.ivrdsl.util.SqlQueryUtils#query
                     */
                    QueryCaseImpl queryCase = () -&gt; {
                        return &quot;&quot;;
                        // TODO: Override this method before executing!
                    };
                                
                }

                &quot;&quot;&quot;;
<span class="fc" id="L133">        ivrBuilder.append(packagePath).append(begin);</span>
<span class="fc" id="L134">        idx = ivrBuilder.length();</span>
<span class="fc" id="L135">        ivrBuilder.append(end);</span>
<span class="fc" id="L136">    }</span>

    /**
     * 构造一个 Java 生成器。
     *
     * @param filepath Java 文件保存路径（不包括文件名，因为生成的文件名是固定的）
     * @param schema   IVR trigger-event映射
     * @see IvrMap
     */
    public Generator(String filepath, IvrMap schema) {
<span class="nc" id="L146">        this(filepath, schema, &quot;&quot;);</span>
<span class="nc" id="L147">    }</span>

    /**
     * 将生成器的生成结果输出。
     */
    public void generateIvr() {
<span class="fc" id="L153">        Set&lt;Map.Entry&lt;String, List&lt;String&gt;&gt;&gt; entrySet = schema.getMap().entrySet();</span>
<span class="fc" id="L154">        List&lt;Map.Entry&lt;String, List&lt;String&gt;&gt;&gt; list = new ArrayList&lt;&gt;(entrySet);</span>
<span class="fc" id="L155">        list.sort(schema);</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">        for (Map.Entry&lt;String, List&lt;String&gt;&gt; item : list) {</span>
<span class="fc" id="L157">            String path = item.getKey();</span>
<span class="fc" id="L158">            String event = item.getValue().get(0);</span>
<span class="fc" id="L159">            String action = item.getValue().get(1);</span>
<span class="fc" id="L160">            String additions = item.getValue().get(2);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            if (&quot;0&quot;.equals(path)) {</span>
<span class="fc" id="L162">                generateTitle(event, additions);</span>
            } else {
<span class="fc" id="L164">                generateEvent(path, event, action, additions);</span>
            }
<span class="fc" id="L166">        }</span>
<span class="fc"
      id="L167">        try (BufferedWriter bufferedWriter = new BufferedWriter(new FileWriter(filename))) {</span>
<span class="fc" id="L168">            bufferedWriter.write(ivrBuilder.toString());</span>
<span class="nc" id="L169">        } catch (IOException e) {</span>
<span class="nc" id="L170">            e.printStackTrace();</span>
<span class="fc" id="L171">        }</span>
<span class="fc" id="L172">        log.info(&quot; Finish : {}&quot;, filename);</span>
<span class="fc" id="L173">    }</span>

    /**
     * 生成标题部分代码。
     *
     * @param title     语音播放使用的标题名
     * @param additions 语音播放中的欢迎语音
     */
    private void generateTitle(String title, String additions) {
<span class="fc" id="L182">        String homeUtilName = &quot;Action_0&quot; + eventRandomName;</span>
<span class="fc" id="L183">        String init = String.format(&quot;&quot;&quot;</span>
                        EventBean %s = new EventBean(&quot;Home&quot;, &quot;%s&quot;, &quot;0&quot;, &quot;%s&quot;);
                        %s.setAction(&quot;&quot;, true);
                                
                        GlobalVariableBean.event2TriggerMap.put(&quot;0&quot;, %s);
                        
                &quot;&quot;&quot;, homeUtilName, title, additions, homeUtilName, homeUtilName);
<span class="fc" id="L190">        ivrBuilder.insert(idx, init);</span>
<span class="fc" id="L191">        idx += init.length();</span>
<span class="fc" id="L192">    }</span>

    /**
     * 生成事件部分代码。
     *
     * @param trigger   触发此处事件的按键路径。根节点路径为“0”，所以所有事件路径都需要加上根节点的“0”，如先后按键“9”“#”触发的事件，其路径为“09#”
     * @param event     语音播放使用的事件名
     * @param action    当前事件触发的动作
     * @param additions 部分动作执行时需要额外的参数，具体请参考 {@link EventLogic#runLogic}
     */
    private void generateEvent(String trigger, String event, String action, String additions) {
<span class="fc" id="L203">        String trigger0 = trigger.replaceAll(&quot;\\*&quot;, &quot;a&quot;);</span>
<span class="fc" id="L204">        trigger0 = trigger0.replaceAll(&quot;#&quot;, &quot;b&quot;);</span>
<span class="fc" id="L205">        String eventName = &quot;Action_&quot; + trigger0;</span>
<span class="fc" id="L206">        String eventUtilName = eventName + eventRandomName;</span>
<span class="fc" id="L207">        String parentUtilName = &quot;Action_&quot; + removeLastChar(trigger0) + eventRandomName;</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        String isFinal = &quot;menu&quot;.equalsIgnoreCase(action) ? &quot;false&quot; :</span>
<span class="pc bpc" id="L209" title="1 of 3 branches missed.">                switch (Objects.requireNonNull(EnumBean.Action.getByCode(action))) {</span>
<span class="fc" id="L210">                    case ACTION_CALL, ACTION_INFO, ACTION_HANGUP, ACTION_MANUAL, ACTION_RECORD -&gt; &quot;true&quot;;</span>
<span class="fc"
      id="L211">                    case ACTION_REPLAY, ACTION_BACK, ACTION_MENU -&gt; &quot;false&quot;;</span>
                };
<span class="fc" id="L213">        String init = String.format(&quot;&quot;&quot;</span>
                                EventBean %s = new EventBean(&quot;%s&quot;, &quot;%s&quot;, &quot;%s&quot;, &quot;%s&quot;);
                                GlobalVariableBean.event2TriggerMap.put(&quot;%s&quot;, %s);
                                %s.setAction(&quot;%s&quot;, %s);
                                %s.addChild(%s);
                                                
<span class="fc" id="L219">                        &quot;&quot;&quot;, eventUtilName, eventName, event, getLastChar(trigger), additions, trigger, eventUtilName,</span>
                eventUtilName, action, isFinal, parentUtilName, eventUtilName);

<span class="fc" id="L222">        ivrBuilder.insert(idx, init);</span>
<span class="fc" id="L223">        idx += init.length();</span>
<span class="fc" id="L224">    }</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>
</div>
</body>
</html>